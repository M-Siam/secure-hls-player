// Vercel serverless function for proxying M3U8
const { createProxyMiddleware } = require('http-proxy-middleware');

module.exports = (req, res) => {
  const token = req.query.token;
  if (!token || token !== 'your-secret-token-123') {  // Replace with dynamic validation
    return res.status(403).json({ error: 'Access Denied: Invalid Token' });
  }

  const proxy = createProxyMiddleware({
    target: 'https://owrcovcrpy.gpcdn.net/bpk-tv/1701/output/',
    changeOrigin: true,
    pathRewrite: (path) => path.replace('/api/secure-stream/', ''),
    onProxyRes: (proxyRes) => {
      res.setHeader('Access-Control-Allow-Origin', '*');  // Adjust for your domain
    }
  });

  // Handle the proxy in serverless context
  return proxy(req, res, (err) => {
    if (err) res.status(500).json({ error: 'Proxy Error' });
  });
};